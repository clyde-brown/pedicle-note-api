# Feature PRD – F006: 통화 이력 조회

> 상태(Status): Draft
> 오너(Owner): PD
> 관련 상위 문서: [Small Business MVP PRD](/docs/10-product/11-prd/small-business-mvp-prd.md)

---

## 1. Context / 목적

Small Business(2-50명) 조직에서 모든 고객 통화가 "개인 기억"이 아닌 "조직 자산"으로 전환되려면, 팀 누구나 언제든 과거 통화를 검색하고 이슈화 진행 상태를 투명하게 확인할 수 있어야 한다.

F006은 "우리가 고객과 언제 무슨 얘기를 했는지, 그것이 이슈로 처리되었는지"를 조직 차원에서 추적 가능하게 만드는 핵심 기능이다.

---

## 2. 사용자 & 사용 시점 (Who / When)

- **Primary 사용자**: Small Business 실무자 (VIEWER 이상 권한)
- **Secondary 사용자**: CEO/대표 (운영 현황 파악용)
- **사용 시점(Trigger)**:
  - 진입: 메인 메뉴 > 통화 관리 > 통화 이력
  - 상황: 고객 재문의 시 과거 통화 이력 확인, 이슈화 누락 통화 발견 시, 팀 처리 현황 점검 시

---

## 3. 사용자 플로우 (User Flow) ⭐️ 핵심

### 3.1 Happy Path

1. 사용자가 날짜 범위(기본: 최근 30일)를 설정하고 통화 이력 페이지에 진입
2. 시스템이 해당 테넌트의 CallSession 목록을 시간순 역순으로 로드 (최신 통화 상단)
3. 사용자가 필요시 **확장된 필터 조건**을 적용: 고객 번호, 이슈화 상태, **통화 방향, 담당자, 통화 길이, 키워드 검색(요약 내용)**
4. 시스템이 필터 조건에 맞는 통화 목록을 테이블 형태로 표시 (**통화 방향, 통화시간, 고객 정보, 요약 제목, 담당자, 통화 길이, 이슈 상태+처리 채널, Slack 전송 상태**)
5. 사용자가 요약 컬럼에 hover하여 **요약 미리보기** 확인 또는 특정 통화의 "통화 상세" 링크를 클릭하여 F014로 이동하거나, "이슈 만들기" 버튼으로 선택적 이슈화 페이지로 이동
6. **Quick Action**: 요약 복사, 관련 이슈 바로 보기, 동일 고객 통화 이력 필터링

### 3.2 주요 분기

- **분기 A(미처리 통화 일괄 이슈화)**: 체크박스로 여러 통화 선택 후 "선택 항목 이슈화" 버튼 클릭 → 일괄 이슈화 모달 또는 F003으로 이동
- **분기 B(기존 이슈 확인)**: 이슈화 완료된 통화의 이슈 링크 클릭 → F011 이슈 조회 페이지의 해당 이슈로 이동
- **분기 C(패턴 분석)**: "유사 통화 찾기" 버튼으로 동일 고객/유사 키워드 통화 필터링 → 반복 이슈 패턴 분석
- **분기 D(데이터 내보내기)**: 필터된 통화 목록을 CSV로 내보내기 → 외부 분석 또는 보고서 작성

---

## 4. 기능 동작 규칙 (Behavior Rules)

- **Rule-01**: 모든 통화 조회는 반드시 현재 사용자의 tenant_id 범위 내에서만 동작한다
- **Rule-02**: 통화 목록은 항상 통화 시작 시간(start_time) 기준 내림차순으로 정렬된다 (정렬 옵션: 통화시간, 통화길이, 고객명, 담당자명)
- **Rule-03**: Slack 전송 상태는 실시간으로 반영되며, 전송 실패 시 "재전송" 액션이 제공된다
- **Rule-04**: 페이지네이션은 50건 단위로 제공되며, 대용량 조회 시 성능 저하를 방지한다
- **Rule-05**: **통화 방향은 CallSession.direction 필드 기반으로 자동 판별**된다 (INBOUND=↙수신, OUTBOUND=↗발신)
- **Rule-06**: **요약 제목은 Summary 본문의 첫 50자를 자동 추출**하여 표시한다 (줄바꿈 제거, 말줄임표 처리)
- **Rule-07**: **고객 정보는 CRM 연동을 통해 회사명/이름을 실시간 조회**하여 캐시한다 (연동 실패 시 전화번호만 표시)
- **Rule-08**: **키워드 검색은 Summary 본문과 고객 정보를 대상**으로 하며, 부분 일치와 한글/영문 조합 검색을 지원한다

---

## 5. 엣지 케이스 & 실패 시 UX

- **테넌트 데이터 없음**: "아직 통화 기록이 없습니다. 첫 통화를 입력해보세요" 메시지와 F001 통화 입력 페이지 링크 제공
- **필터 결과 없음**: "조건에 맞는 통화가 없습니다" 메시지와 필터 조건 초기화 버튼 제공
- **Slack 연동 장애**: Slack 전송 상태가 "실패" 또는 "대기"로 표시되며, "재전송" 버튼으로 수동 복구 가능
- **권한 부족**: VIEWER 미만 권한 사용자는 접근 차단되며 "권한이 없습니다" 메시지 표시

---

## 6. UX / UI 가이드 (디자인 기준)

- **화면 구성**:
  - 상단: 날짜 범위 선택기 + **키워드 검색창(요약 내용)** + **다중 필터 드롭다운** (통화 방향, 담당자, 이슈화 상태, 통화 길이)
  - 중앙: **개선된 통화 목록 테이블** (컬럼: 선택, 통화 방향, 통화시간, 고객 정보, 요약 제목, 담당자, 통화 길이, 이슈 상태+처리 채널, Slack 전송 상태, Quick Actions)
  - 하단: 페이지네이션 (50건 단위) + **선택된 항목 일괄 액션 버튼** + CSV 내보내기

- **필수 UI 상태**:
  - 로딩: 테이블 스켈레톤 UI 표시
  - 비어 있음: 중앙 빈 상태 일러스트 + 안내 메시지 + CTA 버튼
  - 실패: "일시적인 오류가 발생했습니다" + "다시 시도" 버튼
  - **Hover 상태**: 요약 컬럼에 마우스 오버 시 전체 요약 미리보기 툴팁 표시

- **주요 컬럼 및 액션 (개선된 버전)**:
  - **통화 방향**: ↗(발신, 파란색) / ↙(수신, 초록색) 아이콘
  - **통화시간**: YYYY-MM-DD HH:mm 형식 (최근 24시간은 "X시간 전" 표시)
  - **고객 정보**: 회사명 + 담당자명 (CRM 연동) 또는 전화번호 (2줄 표시)
  - **요약 제목**: 첫 50자 + 말줄임표, hover 시 전체 요약 미리보기
  - **통화 길이**: MM:SS 형식, 3분 이하는 주황색 하이라이트
  - **이슈 상태**: 미처리(회색) / 이슈화완료(파란색) + **처리 채널명 표시** + 상태별 아이콘
  - **Quick Actions**: 요약 복사(📋), 관련 이슈 보기(🔗), 동일 고객 필터링(👤), 통화 상세(📞)
  - **Bulk Actions**: 다중 선택 시 "선택 항목 이슈화", "CSV 내보내기" 버튼 활성화

---

## 7. Contract (FE ↔ BE / Event)

### 7.1 FE ↔ BE

- **요청 트리거**: 페이지 로드, 날짜/필터 변경, 페이지네이션 클릭, 정렬 옵션 변경
- **필수 입력**: tenant_id (인증 토큰에서 자동 추출), 날짜 범위(start_date, end_date), 페이지 번호
- **확장 입력 파라미터**:
  - call_direction: INBOUND | OUTBOUND
  - assignee_id: 담당자 ID 필터
  - duration_range: 통화 길이 범위 (예: 0-180초, 180-600초, 600초+)
  - keyword: 요약 내용 키워드 검색
  - sort_by: call_time | duration | customer_name | assignee_name
  - sort_order: ASC | DESC
- **주요 응답 필드 (확장)**:
  - CallSession 목록 + 연관 Issue 상태 + workspace_delivery_status + 총 건수
  - **추가 응답 필드**:
    - customer_name: CRM 연동 고객명
    - company_name: CRM 연동 회사명
    - summary_title: 요약 제목 (첫 50자)
    - issue_channel_name: 이슈 처리 채널명 (있는 경우)
    - call_direction_display: "↗발신" | "↙수신"
- **오류 케이스**: 권한 없음(403), 테넌트 데이터 없음(404), 서버 오류(500) → 각각 적절한 사용자 메시지 표시

### 7.2 이벤트

- **수신 이벤트**: IssueStatusUpdated, WorkspaceDeliveryStatusChanged
- **최소 Payload**: call_session_id, tenant_id, 변경된 상태값
- **실시간 반영**: WebSocket을 통해 테이블의 해당 행 상태 컬럼만 업데이트

---

## 8. Done 기준 (Acceptance Criteria)

- **AC-01**: 테넌트 경계 내에서만 통화 조회가 가능하며, 다른 테넌트 데이터가 노출되지 않는다
- **AC-02**: **확장된 필터 조건**이 정상 동작하고 조건 조합이 AND 로직으로 적용된다 (날짜 범위, 고객 번호, 통화 방향, 담당자, 이슈화 상태, 통화 길이, 키워드 검색)
- **AC-03**: 페이지네이션이 50건 단위로 동작하며, 1000건 이상 데이터에서도 3초 이내 응답이 보장된다
- **AC-04**: Slack 전송 상태가 실시간으로 반영되며, 실패 시 "재전송" 액션이 동작한다
- **AC-05**: "통화 상세" 링크로 F014 페이지 정상 이동, "이슈 만들기" 버튼으로 F003 선택적 이슈화 페이지 정상 이동
- **AC-06**: VIEWER 이상 권한 검증이 정상 동작하고, 권한 부족 시 접근이 차단된다
- **AC-07**: **요약 hover 미리보기**가 정상 동작하며, 툴팁이 화면 경계를 벗어나지 않게 위치 조정된다
- **AC-08**: **일괄 선택/액션**이 정상 동작하며, 체크박스 전체 선택과 개별 선택이 모두 지원된다
- **AC-09**: **CSV 내보내기**가 현재 필터 조건을 반영하여 동작하며, 최대 1000건까지 지원한다
- **AC-10**: **고객 정보 CRM 연동**이 정상 동작하며, 연동 실패 시에도 전화번호는 표시된다
- **AC-11**: **키워드 검색**이 Summary 본문과 고객 정보를 대상으로 정확히 동작하며, 한글/영문/숫자 조합 검색을 지원한다

---

## 9. 오픈 질문 / 정책 요청 (있다면)

- **Q-01**: 통화 이력 데이터 보존 기간 정책은? (예: 1년, 3년, 무제한) → P-REQ-F006-01
- **Q-02**: 대용량 테넌트(월 10,000건 이상 통화)의 성능 기준과 아카이빙 전략은? → P-REQ-F006-02
- **Q-03**: **CSV 내보내기 시 개인정보 마스킹 정책**은? (전화번호, 고객명 등) → P-REQ-F006-03
- **Q-04**: **CRM 연동 실패 시 고객 정보 캐시 정책**은? (캐시 기간, 재시도 주기) → P-REQ-F006-04
- **Q-05**: **일괄 이슈화 시 동일 채널 강제 여부**는? (사용자 선택 vs 자동 분산) → P-REQ-F006-05
- **Q-06**: **요약 미리보기 툴팁에서 민감 정보 필터링** 기준은? → P-REQ-F006-06